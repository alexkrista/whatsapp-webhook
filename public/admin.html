<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baustellenprotokoll – Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 14px 0; }
    input, button { padding: 10px 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
    button { cursor: pointer; background: #111; color: #fff; border-color:#111; }
    button.secondary { background:#fff; color:#111; border-color:#ccc; }
    button.danger { background:#b00020; border-color:#b00020; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; text-align:left; }
    .muted { color:#666; font-size: 13px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; font-size: 12px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; white-space: pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .right { margin-left:auto; }
  </style>
</head>
<body>
  <h1>Admin</h1>
  <div class="muted">Projektübersicht + Löschen (Job/Tag). Token wird nur im Browser gespeichert.</div>

  <div class="card">
    <div class="row">
      <label class="muted">ADMIN Token:</label>
      <input id="token" type="password" placeholder="ADMIN_TOKEN" style="min-width:280px" />
      <button class="secondary" id="saveToken">Speichern</button>
      <button id="loadJobs">Liste laden</button>
      <span class="right muted" id="baseUrl"></span>
    </div>
    <div class="muted" style="margin-top:8px">
      Endpoints: <span class="mono">/admin/list-jobs</span>, <span class="mono">/admin/delete-job</span>, <span class="mono">/admin/delete-day</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Schnell-Löschen</h3>
    <div class="row">
      <input id="jobInput" placeholder="job (z.B. 260016)" />
      <input id="dateInput" placeholder="date (YYYY-MM-DD)" />
      <button class="danger" id="deleteDayBtn">Tag löschen</button>
      <button class="danger" id="deleteJobBtn">Job löschen</button>
    </div>
    <div class="muted" style="margin-top:8px">
      ⚠️ Löschen ist endgültig (Ordner wird entfernt).
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h3 style="margin:0;">Jobs</h3>
      <span class="right muted" id="count"></span>
    </div>
    <div id="jobsWrap" class="muted">Noch keine Daten geladen.</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Status</h3>
    <div id="status" class="mono"></div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const statusEl = $("status");
  function logStatus(msg, isErr=false) {
    const p = document.createElement("div");
    p.className = isErr ? "err" : "ok";
    p.textContent = msg;
    statusEl.prepend(p);
  }

  function getToken() {
    return $("token").value.trim();
  }

  function setBaseUrl() {
    $("baseUrl").textContent = location.origin;
  }

  function saveToken() {
    localStorage.setItem("ADMIN_TOKEN", $("token").value);
    logStatus("✅ Token gespeichert");
  }

  function loadToken() {
    const t = localStorage.getItem("ADMIN_TOKEN") || "";
    $("token").value = t;
  }

  async function apiGet(path, params={}) {
    const url = new URL(location.origin + path);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method: "GET" });
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { json = null; }
    if (!res.ok) throw new Error(json?.error || text || ("HTTP " + res.status));
    return json ?? text;
  }

  async function apiDelete(path, params={}) {
    const url = new URL(location.origin + path);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method: "DELETE" });
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { json = null; }
    if (!res.ok) throw new Error(json?.error || text || ("HTTP " + res.status));
    return json ?? text;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function renderJobs(jobs) {
    if (!Array.isArray(jobs) || jobs.length === 0) {
      $("jobsWrap").innerHTML = "<div class='muted'>Keine Jobs gefunden.</div>";
      $("count").textContent = "";
      return;
    }

    $("count").textContent = jobs.length + " Jobs";

    const rows = jobs.map(j => {
      const jobId = escapeHtml(j.jobId);
      const latestDay = escapeHtml(j.latestDay || "");
      const items = j.itemsLastDay ?? 0;
      const imgs = j.imagesLastDay ?? 0;
      const aud  = j.audioLastDay ?? 0;

      return `
        <tr>
          <td><b>#${jobId}</b><div class="muted">latest: ${latestDay || "-"}</div></td>
          <td>
            <span class="pill">items ${items}</span>
            <span class="pill">img ${imgs}</span>
            <span class="pill">audio ${aud}</span>
          </td>
          <td class="actions">
            <button class="secondary" data-fill-job="${jobId}" data-fill-date="${latestDay}">in Felder</button>
            <button class="danger" data-del-day="${jobId}" data-day="${latestDay}">Tag löschen</button>
            <button class="danger" data-del-job="${jobId}">Job löschen</button>
          </td>
        </tr>
      `;
    }).join("");

    $("jobsWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Job</th>
            <th>Letzter Tag</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    // wire buttons
    $("jobsWrap").querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", async () => {
        const token = getToken();
        if (!token) return logStatus("❌ ADMIN_TOKEN fehlt", true);

        // fill
        if (btn.dataset.fillJob) {
          $("jobInput").value = btn.dataset.fillJob;
          $("dateInput").value = btn.dataset.fillDate || "";
          return;
        }

        // delete day
        if (btn.dataset.delDay) {
          const job = btn.dataset.delDay;
          const date = btn.dataset.day;
          if (!date) return logStatus("❌ Kein latestDay vorhanden – bitte Datum manuell eingeben", true);

          const ok = confirm(`Wirklich löschen?\nJob: ${job}\nTag: ${date}\n\nDas ist endgültig.`);
          if (!ok) return;

          try {
            const out = await apiDelete("/admin/delete-day", { token, job, date });
            logStatus("✅ Tag gelöscht: " + JSON.stringify(out));
            await loadJobs();
          } catch (e) {
            logStatus("❌ " + e.message, true);
          }
          return;
        }

        // delete job
        if (btn.dataset.delJob) {
          const job = btn.dataset.delJob;

          const ok = confirm(`Wirklich JOB löschen?\nJob: ${job}\n\nAlle Tage/Dateien werden entfernt. Endgültig!`);
          if (!ok) return;

          try {
            const out = await apiDelete("/admin/delete-job", { token, job });
            logStatus("✅ Job gelöscht: " + JSON.stringify(out));
            await loadJobs();
          } catch (e) {
            logStatus("❌ " + e.message, true);
          }
          return;
        }
      });
    });
  }

  async function loadJobs() {
    const token = getToken();
    if (!token) return logStatus("❌ ADMIN_TOKEN fehlt", true);

    try {
      const data = await apiGet("/admin/list-jobs", { token });
      renderJobs(data.jobs || []);
      logStatus("✅ Liste aktualisiert");
    } catch (e) {
      logStatus("❌ " + e.message, true);
    }
  }

  async function deleteDayQuick() {
    const token = getToken();
    const job = $("jobInput").value.trim();
    const date = $("dateInput").value.trim();
    if (!token) return logStatus("❌ ADMIN_TOKEN fehlt", true);
    if (!job || !date) return logStatus("❌ Bitte job UND date eingeben", true);

    const ok = confirm(`Wirklich löschen?\nJob: ${job}\nTag: ${date}\n\nEndgültig.`);
    if (!ok) return;

    try {
      const out = await apiDelete("/admin/delete-day", { token, job, date });
      logStatus("✅ Tag gelöscht: " + JSON.stringify(out));
      await loadJobs();
    } catch (e) {
      logStatus("❌ " + e.message, true);
    }
  }

  async function deleteJobQuick() {
    const token = getToken();
    const job = $("jobInput").value.trim();
    if (!token) return logStatus("❌ ADMIN_TOKEN fehlt", true);
    if (!job) return logStatus("❌ Bitte job eingeben", true);

    const ok = confirm(`Wirklich JOB löschen?\nJob: ${job}\n\nALLE Daten weg. Endgültig!`);
    if (!ok) return;

    try {
      const out = await apiDelete("/admin/delete-job", { token, job });
      logStatus("✅ Job gelöscht: " + JSON.stringify(out));
      await loadJobs();
    } catch (e) {
      logStatus("❌ " + e.message, true);
    }
  }

  // init
  setBaseUrl();
  loadToken();

  $("saveToken").addEventListener("click", saveToken);
  $("loadJobs").addEventListener("click", loadJobs);
  $("deleteDayBtn").addEventListener("click", deleteDayQuick);
  $("deleteJobBtn").addEventListener("click", deleteJobQuick);
</script>
</body>
</html>
